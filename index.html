<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>5カードドローポーカー</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <h1>5カードドローポーカー</h1>

    <button id="startBtn">ゲーム開始</button>
    <div class="label">プレイヤーの手</div>
    <div id="hand" class="cards" aria-live="polite"></div>

    <div id="status" class="label">選択: 0 / 残りカード: -</div>
    <div id="handEval" class="label"></div>

    <button id="drawBtn" style="display:none;">選択カードを交換（0）</button>

    <div class="label">ディーラーの手</div>
    <div id="dealer" class="cards" aria-live="polite"></div>

    <div id="result"></div>

    <!-- 役一覧（テーブル） -->
    <section id="ranksSection" class="ranks-section">
        <h2>役一覧（強い順）</h2>
        <p class="ranks-note">現在の手に該当する役は表で強調表示されます。</p>
        <table id="handRanks" class="hand-ranks" aria-describedby="ranksSection">
            <thead>
                <tr><th>順位</th><th>役名</th><th>説明</th></tr>
            </thead>
            <tbody>
                <!-- data-rank は evaluateHand の score[0] と一致させる -->
                <tr data-rank="8"><td>1</td><td>ストレートフラッシュ</td><td>同じ絵柄で連続した5枚（ロイヤル含む）</td></tr>
                <tr data-rank="7"><td>2</td><td>フォー・オブ・ア・カインド</td><td>同じランクが4枚（×4）</td></tr>
                <tr data-rank="6"><td>3</td><td>フルハウス</td><td>スリー＋ペア（3枚＋2枚）</td></tr>
                <tr data-rank="5"><td>4</td><td>フラッシュ</td><td>同じ絵柄の5枚（連番は不要）</td></tr>
                <tr data-rank="4"><td>5</td><td>ストレート</td><td>連続した5枚（Aは高または A-2-3-4-5 の低扱い）</td></tr>
                <tr data-rank="3"><td>6</td><td>スリー・オブ・ア・カインド</td><td>同じランクが3枚（残り2枚は異なる）</td></tr>
                <tr data-rank="2"><td>7</td><td>ツーペア</td><td>2つのペア＋キッカー1枚</td></tr>
                <tr data-rank="1"><td>8</td><td>ワンペア</td><td>同じランクが2枚（残り3枚は異なる）</td></tr>
                <tr data-rank="0"><td>9</td><td>ハイカード</td><td>上記に該当しないとき。最上位のカードで比較</td></tr>
            </tbody>
        </table>
    </section>

    <script>
        let deckId = "";
        let deckRemaining = 52;
        let hand = [];
        let dealerHand = [];
        let selectedIndexes = new Set();
        let exchanged = false;

        const startBtn = document.getElementById("startBtn");
        const drawBtn = document.getElementById("drawBtn");
        const handDiv = document.getElementById("hand");
        const dealerDiv = document.getElementById("dealer");
        const resultDiv = document.getElementById("result");
        const statusDiv = document.getElementById("status");
        const handEvalDiv = document.getElementById("handEval");
        const handRanksTable = document.getElementById("handRanks");

        startBtn.onclick = async () => {
            exchanged = false;
            resultDiv.textContent = "";
            dealerDiv.innerHTML = "";
            handEvalDiv.textContent = "";
            selectedIndexes.clear();

            const deck = await fetch("https://deckofcardsapi.com/api/deck/new/shuffle/?deck_count=1").then(r => r.json());
            deckId = deck.deck_id;
            deckRemaining = deck.remaining || 52;

            const draw = await fetch(`https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=5`).then(r => r.json());
            hand = draw.cards;
            deckRemaining = draw.remaining || deckRemaining;
            showHand();
            updateStatus();
            drawBtn.style.display = "inline-block";
            drawBtn.disabled = false;
        };

        function showHand() {
            handDiv.innerHTML = "";
            hand.forEach((card, index) => {
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";
                cardDiv.setAttribute("role", "button");
                cardDiv.setAttribute("tabindex", "0");
                cardDiv.setAttribute("aria-pressed", selectedIndexes.has(index) ? "true" : "false");
                cardDiv.setAttribute("aria-label", `${index + 1}番: ${card.value} の ${card.suit}`);

                const img = document.createElement("img");
                img.src = card.image;
                img.alt = `${card.value} of ${card.suit}`;

                const badge = document.createElement("span");
                badge.className = "badge";
                badge.textContent = "選択中";

                cardDiv.onclick = () => { toggleSelect(index, cardDiv); };
                cardDiv.onkeydown = (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        toggleSelect(index, cardDiv);
                    }
                };

                if (selectedIndexes.has(index)) cardDiv.classList.add("selected");

                cardDiv.appendChild(img);
                cardDiv.appendChild(badge);
                handDiv.appendChild(cardDiv);
            });

            // キーボード1-5で選択切替（数字キー）
            // 既に同じイベントを重複登録しないように一度だけ設定
            if (!document._pokerKeyInit) {
                document.addEventListener('keydown', (e) => {
                    // 1〜5 のキーでカードを選択
                    if (!exchanged && e.key >= '1' && e.key <= '5') {
                        const idx = parseInt(e.key, 10) - 1;
                        const cardNodes = handDiv.querySelectorAll('.card');
                        if (cardNodes[idx]) {
                            cardNodes[idx].focus();
                            toggleSelect(idx, cardNodes[idx]);
                        }
                    }
                });
                document._pokerKeyInit = true;
            }

            updateHandEvaluation();
            updateStatus();
        }

        function showDealer() {
            dealerDiv.innerHTML = "";
            dealerHand.forEach((card, index) => {
                const cardDiv = document.createElement("div");
                cardDiv.className = "card";
                const img = document.createElement("img");
                img.src = card.image;
                img.alt = `${card.value} of ${card.suit}`;
                cardDiv.appendChild(img);
                dealerDiv.appendChild(cardDiv);
            });
        }

        function toggleSelect(index, cardDiv) {
            if (exchanged) return; // 交換後は選択不可
            if (selectedIndexes.has(index)) {
                selectedIndexes.delete(index);
                cardDiv.classList.remove("selected");
                cardDiv.setAttribute("aria-pressed", "false");
            } else {
                selectedIndexes.add(index);
                cardDiv.classList.add("selected");
                cardDiv.setAttribute("aria-pressed", "true");
            }
            updateStatus();
        }

        function updateStatus() {
            const count = selectedIndexes.size;
            statusDiv.textContent = `選択: ${count} / 残りカード: ${deckRemaining}`;
            drawBtn.textContent = `選択カードを交換（${count}）`;
        }

        function updateHandEvaluation() {
            if (hand.length === 5) {
                const evalRes = evaluateHand(hand);
                handEvalDiv.textContent = `現在の役: ${evalRes.name}`;
                // テーブル内のハイライト更新
                Array.from(handRanksTable.querySelectorAll('tr')).forEach(row => {
                    row.classList.remove('current');
                });
                const matched = handRanksTable.querySelector(`tr[data-rank="${evalRes.score[0]}"]`);
                if (matched) matched.classList.add('current');
            } else {
                handEvalDiv.textContent = "";
                Array.from(handRanksTable.querySelectorAll('tr')).forEach(row => row.classList.remove('current'));
            }
        }

        drawBtn.onclick = async () => {
            if (exchanged) return;
            const count = selectedIndexes.size;
            // 引き直したくない場合は0でもディーラー対戦する
            const draw = await fetch(`https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=${count}`).then(r => r.json());
            const newCards = draw.cards || [];
            deckRemaining = draw.remaining || deckRemaining;

            let i = 0;
            [...selectedIndexes].forEach(idx => {
                hand[idx] = newCards[i];
                i++;
            });
            selectedIndexes.clear();
            exchanged = true;
            drawBtn.disabled = true;

            showHand();

            // ディーラーが5枚引く
            const d = await fetch(`https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=5`).then(r => r.json());
            dealerHand = d.cards;
            deckRemaining = d.remaining || deckRemaining;
            showDealer();

            const pEval = evaluateHand(hand);
            const dEval = evaluateHand(dealerHand);

            const cmp = compareHands(pEval.score, dEval.score);

            // 強調表示
            if (cmp > 0) {
                highlightWinner(handDiv);
                resultDiv.textContent = `あなたの勝ち — あなた: ${pEval.name} / ディーラー: ${dEval.name}`;
            } else if (cmp < 0) {
                highlightWinner(dealerDiv);
                resultDiv.textContent = `あなたの負け — あなた: ${pEval.name} / ディーラー: ${dEval.name}`;
            } else {
                resultDiv.textContent = `引き分け — あなた: ${pEval.name} / ディーラー: ${dEval.name}`;
            }

            updateStatus();
        };

        function highlightWinner(container) {
            Array.from(container.querySelectorAll('.card')).forEach(cd => cd.classList.add('winner'));
        }

        // 値を数値化
        function valueToRank(v) {
            if (v === "ACE") return 14;
            if (v === "KING") return 13;
            if (v === "QUEEN") return 12;
            if (v === "JACK") return 11;
            return parseInt(v, 10);
        }

        // 役を判定して比較用のスコア配列を返す
        function evaluateHand(cards) {
            const ranks = cards.map(c => valueToRank(c.value)).sort((a, b) => b - a);
            const suits = cards.map(c => c.suit);
            const counts = {};
            ranks.forEach(r => counts[r] = (counts[r] || 0) + 1);
            const countsArr = Object.entries(counts).map(([r, c]) => ({ rank: parseInt(r), count: c }))
                .sort((a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    return b.rank - a.rank;
                });

            const isFlush = suits.every(s => s === suits[0]);

            // straight 判定（A-2-3-4-5 を許可）
            let isStraight = false;
            let straightHigh = 0;
            const uniqRanks = Array.from(new Set(ranks)).sort((a, b) => a - b);
            if (uniqRanks.length === 5) {
                const max = uniqRanks[4], min = uniqRanks[0];
                if (max - min === 4) {
                    isStraight = true;
                    straightHigh = max;
                } else {
                    if (uniqRanks.toString() === [2, 3, 4, 5, 14].toString()) {
                        isStraight = true;
                        straightHigh = 5;
                    }
                }
            }

            let score = [];
            let name = "";

            if (isStraight && isFlush) {
                name = "ストレートフラッシュ";
                score = [8, straightHigh];
            } else if (countsArr[0].count === 4) {
                name = "フォー・オブ・ア・カインド";
                const quad = countsArr[0].rank;
                const kicker = countsArr[1].rank;
                score = [7, quad, kicker];
            } else if (countsArr[0].count === 3 && countsArr[1] && countsArr[1].count === 2) {
                name = "フルハウス";
                score = [6, countsArr[0].rank, countsArr[1].rank];
            } else if (isFlush) {
                name = "フラッシュ";
                score = [5, ...ranks];
            } else if (isStraight) {
                name = "ストレート";
                score = [4, straightHigh];
            } else if (countsArr[0].count === 3) {
                name = "スリー・オブ・ア・カインド";
                const trip = countsArr[0].rank;
                const kickers = countsArr.slice(1).map(x => x.rank).sort((a,b)=>b-a);
                score = [3, trip, ...kickers];
            } else if (countsArr[0].count === 2 && countsArr[1] && countsArr[1].count === 2) {
                name = "ツーペア";
                const highPair = Math.max(countsArr[0].rank, countsArr[1].rank);
                const lowPair = Math.min(countsArr[0].rank, countsArr[1].rank);
                const kicker = countsArr.find(x => x.count === 1).rank;
                score = [2, highPair, lowPair, kicker];
            } else if (countsArr[0].count === 2) {
                name = "ワンペア";
                const pair = countsArr[0].rank;
                const kickers = countsArr.slice(1).map(x => x.rank).sort((a,b)=>b-a);
                score = [1, pair, ...kickers];
            } else {
                name = "ハイカード";
                score = [0, ...ranks];
            }

            return { name, score };
        }

        function compareHands(aScore, bScore) {
            for (let i = 0; i < Math.max(aScore.length, bScore.length); i++) {
                const a = aScore[i] || 0;
                const b = bScore[i] || 0;
                if (a > b) return 1;
                if (a < b) return -1;
            }
            return 0;
        }
    </script>
</body>

</html>